name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write
  id-token: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install build
      - run: python -m build
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: pypi
      url: https://pypi.org/p/monique
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - uses: pypa/gh-action-pypi-publish@release/v1

  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ github.ref_name }}" dist/* \
            --title "${{ github.ref_name }}" \
            --generate-notes

  aur:
    name: Publish to AUR
    runs-on: ubuntu-latest
    needs: github-release
    steps:
      - uses: actions/checkout@v4
      - name: Extract version from tag
        id: version
        run: echo "pkgver=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
      - name: Update PKGBUILD
        run: |
          # Download the source tarball and compute sha256
          curl -sL "https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz" -o source.tar.gz
          SHA256=$(sha256sum source.tar.gz | cut -d' ' -f1)

          cd aur
          sed -i "s/^pkgver=.*/pkgver=${{ steps.version.outputs.pkgver }}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/sha256sums=('SKIP')/sha256sums=('$SHA256')/" PKGBUILD
      - name: Generate .SRCINFO
        uses: docker://archlinux:latest
        with:
          entrypoint: bash
          args: -c "pacman -Sy --noconfirm pacman-contrib && useradd -m builder && chown -R builder aur && su builder -c 'cd aur && makepkg --printsrcinfo > .SRCINFO'"
      - name: Push to AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur_rsa
          chmod 600 ~/.ssh/aur_rsa
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts 2>/dev/null

          git clone ssh://aur@aur.archlinux.org/monique.git /tmp/aur-monique \
            --config core.sshCommand="ssh -i ~/.ssh/aur_rsa -o IdentitiesOnly=yes"

          cp aur/PKGBUILD aur/.SRCINFO /tmp/aur-monique/
          cd /tmp/aur-monique
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${{ steps.version.outputs.pkgver }}"
          git push
